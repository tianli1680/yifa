name: æ›´æ–°æ’­æ”¾åˆ—è¡¨

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-file:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æ’­æ”¾åˆ—è¡¨å¹¶ä¿å­˜ä¸º yifa.txt
        run: |
          echo "ğŸš€ å¼€å§‹ä»æºURLè·å–æ’­æ”¾åˆ—è¡¨..."
          # ä½¿ç”¨ -L è·Ÿéšé‡å®šå‘ï¼Œ-f ä½¿HTTPé”™è¯¯æ—¶é€€å‡ºï¼Œ--retry å¢åŠ å®¹é”™
          curl -L -f --retry 3 -o yifa.txt "https://tvv.tw/github.com/fafa002/yf2025/blob/main/yiyifafa.txt"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸä¸”éç©º
          if [ ! -s yifa.txt ]; then
            echo "âŒ é”™è¯¯ï¼šä¸‹è½½çš„æ–‡ä»¶ä¸ºç©ºæˆ–å¤±è´¥ï¼"
            exit 1
          fi
          
          echo "âœ… ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å¤§å°ï¼š$(wc -c < yifa.txt) å­—èŠ‚"
          echo "ğŸ“„ æ–‡ä»¶å†…å®¹é¢„è§ˆï¼ˆå‰5è¡Œï¼‰ï¼š"
          head -n 5 yifa.txt
      
      - name: æäº¤å¹¶æ¨é€æ›´æ–°
        run: |
          # é…ç½®gitç”¨æˆ·
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # è·å–å½“å‰åˆ†æ”¯å
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "å½“å‰åˆ†æ”¯ï¼š$CURRENT_BRANCH"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet yifa.txt; then
            echo "â„¹ï¸ æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            echo "ğŸ“¦ æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œå‡†å¤‡æäº¤..."
            git add yifa.txt
            git commit -m "è‡ªåŠ¨æ›´æ–°æ’­æ”¾åˆ—è¡¨ - $(date +'%Y-%m-%d %H:%M:%S')"
            
            echo "â¬†ï¸ æ­£åœ¨æ¨é€åˆ°åˆ†æ”¯ $CURRENT_BRANCH ..."
            git push origin HEAD:$CURRENT_BRANCH
            echo "âœ… æ›´æ–°å·²æˆåŠŸæ¨é€è‡³ä»“åº“ï¼"
          fi
