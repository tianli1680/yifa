name: 更新播放列表

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

# 授予完整的写入权限
permissions:
  contents: write
  actions: write

jobs:
  create-and-update-file:
    runs-on: ubuntu-latest
    
    steps:
      # 步骤1：检出仓库
      - name: 1️⃣ 检出仓库代码
        uses: actions/checkout@v4
      
      # 步骤2：下载并过滤内容
      - name: 2️⃣ 下载并过滤播放列表内容
        run: |
          echo "开始下载播放列表内容..."
          
          # 下载文件内容并过滤掉指定行
          curl -L -f "https://tvv.tw/github.com/fafa002/yf2025/blob/main/yiyifafa.txt" | \
          grep -v "盗源狗si全家 全家下地狱" > yifa.txt
          
          # 验证文件是否成功创建
          if [ -f "yifa.txt" ]; then
            echo "✅ 文件 yifa.txt 已成功创建"
            echo "文件行数: $(wc -l < yifa.txt) 行"
            echo "文件大小: $(wc -c < yifa.txt) 字节"
            echo -e "\n📄 文件内容预览（前5行）:"
            head -n 5 yifa.txt
            echo -e "\n📄 文件内容预览（后3行）:"
            tail -n 3 yifa.txt
          else
            echo "❌ 文件创建失败"
            exit 1
          fi
      
      # 步骤3：验证过滤效果
      - name: 3️⃣ 验证不良内容已被删除
        run: |
          if grep -q "盗源狗si全家 全家下地狱" yifa.txt; then
            echo "❌ 错误：不良内容仍然存在于文件中"
            exit 1
          else
            echo "✅ 验证通过：不良内容已被成功删除"
          fi
      
      # 步骤4：强制推送文件到仓库
      - name: 4️⃣ 强制推送文件到仓库
        run: |
          # 配置git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 显示当前状态
          echo "当前目录内容:"
          ls -la
          
          # 确保yifa.txt存在
          if [ ! -f "yifa.txt" ]; then
            echo "❌ 错误: yifa.txt 不存在"
            exit 1
          fi
          
          # 添加文件到git
          git add yifa.txt -f
          
          # 检查是否有变化需要提交
          if git diff --staged --quiet; then
            echo "文件内容没有变化，跳过提交"
          else
            # 提交更改
            git commit -m "更新播放列表文件 - $(date +'%Y-%m-%d %H:%M:%S')"
            
            # 获取当前分支名
            BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
            echo "当前分支: $BRANCH_NAME"
            
            # 拉取最新更改并推送
            git pull origin $BRANCH_NAME --rebase
            git push origin $BRANCH_NAME
            
            echo "✅ 文件已成功推送到仓库！"
          fi
      
      # 步骤5：最终验证
      - name: 5️⃣ 最终验证
        run: |
          echo "等待几秒钟让文件同步..."
          sleep 5
          
          echo "检查仓库中的文件:"
          if [ -f "yifa.txt" ]; then
            echo "✅ 确认: yifa.txt 存在于工作目录"
            echo "文件位置: $(pwd)/yifa.txt"
            echo -e "\n📄 完整的干净文件内容:"
            echo "----------------------------------------"
            cat yifa.txt
            echo "----------------------------------------"
            
            # 再次验证不良内容
            if grep -q "盗源狗si全家 全家下地狱" yifa.txt; then
              echo "❌ 错误：不良内容仍然存在！"
              exit 1
            else
              echo "✅ 最终确认：文件内容干净，没有不良信息"
            fi
          else
            echo "❌ 警告: 在目录中找不到 yifa.txt"
            exit 1
          fi
